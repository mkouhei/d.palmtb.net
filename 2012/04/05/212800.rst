iPXEでサーバの機器情報を取得する。
======================================================

新しい機器をラックマウントする際には、納品時にメーカー、型番、シリアル番号を控え、ラック位置、棚位置とひもづける必要があるかと思います。この手の管理作業は台数が増えるほど手間が増えるので手作業ではやりたくないことの一つです。サーバ機器の場合、インストールするOSが一律なら特に問題ありませんが、OSの種類が違っていたり、インストール後にChefなどではやりにく設定はインストール時にやる場合、対象のサーバを識別する必要があります。どの型番、スペックの機器を使うか、という観点ではシリアル番号での識別が必要ですが、PXEブートでOSのカスタムインストールを行うためにはMACアドレスで認識する必要があります。

OSの自動インストールツール
**************************************

OSの自動インストールを行うためのツールとしては、`Cobbler <https://fedorahosted.org/cobbler/>`_ や、最近では`Crowbar <https://github.com/dellcloudedge/crowbar>`_ などがありますが、インストール対象としてサポートされているOSの種類が足りなかったり、今の環境に合わせた柔軟性なかったり、ということもあり、もともと `t9mdさん <https://twitter.com/t9md>`_ が開発した　`pxelerator <https://github.com/t9md/pxelerator>`_ というリモートインストールツールを使っています。現在の環境だけでの運用だけでなく、次のDCに向けて継続的に開発を今も続けています。 [#]_ 

現在のpxeleratorではPXEブートでインストールをするときにMACアドレスとシリアル番号を `iPXE <http://ipxe.org/>`_ を使ってログに出力する、ということを行っていましたが、資産管理およびラック構成図の自動生成・管理も行いたいので、iPXEを使ってメーカーと型番も取得するようにしました。また、pxeleratorで使用するDHCP, TFTP, DNSの機能は、dnsmasqを使っており、インストール対象の識別にMACアドレスをキーにしているので、これも自動登録を行うようにしました。iPXEでどうやって情報を取得するかを紹介したいと思います。

iPXEの設定
******************

iPXEの設定は下記のようにします。

.. code-block:: bash

   #!ipxe
   
   dhcp
   chain http://${next-server}:9393/report_serial/${serial:uristring}/${mac}/${manufacturer:uristring}/${product:uristring}


* ${serial:

その他の設定項目については `Upstreamのドキュメント <http://ipxe.org/cfg>`_ を参照ください。


リクエスト先のURLは、Sinatra


.. rubric:: footnote

   .. [#] Githubで公開されているのはかなり初期のバージョンなので今とだいぶ違いますし、今回の話の機能はもちろんありません。


.. author:: default
.. categories:: Ops
.. tags:: iPXE,Ruby,Sinatra
.. comments::
